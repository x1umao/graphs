<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" type="image/png" href="images/favicon-small.png" sizes="16x16">
    <link rel="icon" type="image/png" href="images/favicon-large.png" sizes="32x32">
    <title>Graphs DB</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body class="person-bg">
<div class="container">
    <div class="row">
        <div class="col-12 col-lg-8">
            <div class="row pt-0 pb-2 pt-md-4">
                <div class="col-12 col-md-4 col-lg-3 my-auto">
                    <div class="logo py-5 py-md-0 ">
                        <a href="/">
                            <img src="images/graphs-logo.svg" class="mx-auto mx-md-0">
                        </a>
                    </div>
                </div>
                <div class="col-12 col-md-8 col-lg-9">
                    <div class="form-group form-search mb-0 mr-6 pr-3">
                        <span class="fa fa-search form-icon"></span>
                        <input type="text" class="form-control" id="search" placeholder="Search person, article, journal...">
                        <div class="search-dropdown" id="suggest" style="display: none">
                            <button type="button" class="dropdown-item" onclick="toList(this)"> <span id="person"></span> results in <em>Person</em></button>
                            <button type="button" class="dropdown-item" onclick="toList(this)"> <span id="article"></span> results in <em>Article</em></button>
                            <button type="button" class="dropdown-item" onclick="toList(this)"> <span id="journal"></span> results in <em>Journal</em></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row pb-5 pb-md-4">
        <div class="col-12 col-lg-8">
            <div class="card-m card-person">
                <div class="row">
                    <div class="col-2 col-lg-1">
                        <span class="fa fa-user-circle card-icon"></span>
                    </div>
                    <div class="col-10 col-lg-11">
                        <h4 class="pb-3" th:text="${pDetailVO.person.name}">Edson C. Tandoc Jr.</h4>
                        <p th:text="${pDetailVO.person.gender}">Male</p>
                        <p class="ml-5"><b>Articles</b></p>
                        <p class="ml-3" th:text="${pDetailVO.counter}">Nil</p>
                    </div>
                </div>
            </div>
            <div class="card-m card-graph">
                <div id="graphContainer" style="width: 100%;height:600px"></div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="row">
                <div class="col-12 col-md-6 col-lg-12">
                    <div class="card-m">
                        <h5>Articles</h5>
                        <div id="column-chart-person" class="pt-4"></div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-12">
                    <div class="card-m">
                        <h5>Related Persons</h5>
                        <div th:each="p:${pDetailVO.relatedPerson}">
                            <a th:href="|person-detail?name=${p.name}|" class="card-hover">
                                <div class="card-s card-person card-s-person">
                                    <span class="fa fa-user-circle card-icon"></span>
                                    <div class="card-s-info ml-5">
                                        <h6 class="mb-1" th:text="${p.name}">Patrick Ferrucci</h6>
                                        <p th:text="${p.gender}">Male</p>
                                        <p class="ml-4"><b>Articles</b></p>
                                        <p class="ml-2" th:text="${p.counter}">121</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/search.js"></script>
<script th:inline="javascript">
    const graph = /*[[${pDetailVO.echartsVO}]]*/ "??";
    renderGraph();
    renderBar();

    function renderGraph() {
        const dom = document.getElementById("graphContainer");
        const myChart = echarts.init(dom);
        const app = {};
        let option;
        const colorTable = ['rgba(76, 142, 230, 1)', 'rgba(228, 78, 43, 1)', 'rgba(248, 181, 41, 1)'];
        // myChart.showLoading();
        graph.nodes.forEach(function (node) {
            node.symbolSize = 50;
        });
        graph.nodes.forEach(function (node) {
            node.category = parseInt(node.category);
            if(node.category===1){
                node.value = "Year: "+node.value;
            }
            node.label = {show:false};
        })
        graph.nodes.forEach(function (node){

        })
        option = {
            title: {
                text: ' ',
                subtext: 'Default layout',
                top: 'bottom',
                left: 'right'
            },
            tooltip: {}
            ,toolbox: {
                show: true,
                itemSize: 30,
                top: '90%',
                right: '5%',
                feature: {
                    saveAsImage: {}
                }
            },
            legend: [{
                // selectedMode: 'single',
                data: graph.category.map(function (a) {
                    return a.name;
                })
            }],
            series: [
                {
                    type: 'graph',
                    layout: 'force',
                    data: graph.nodes,
                    links: graph.links,
                    categories: graph.category,
                    roam: true,
                    draggable: true,
                    layoutAnimation: false,
                    label: {
                        normal: {
                            show: false,
                        }
                    },
                    force: {
                        initLayout:'force',
                        repulsion: 300,
                        edgeLength: 300
                    },
                    edgeSymbol:['none', 'arrow'],
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: {
                            width: 10
                        }
                    }
                }
            ],
            color: colorTable
        };

        myChart.setOption(option);

        if (option && typeof option === 'object') {
            myChart.setOption(option);
        }
    }

    function renderBar() {
        // set the dimensions and margins of the graph
        var margin = {top: 0, right: 0, bottom: 30, left: 0},
            width = 800 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        // set the ranges
        var x = d3.scaleBand()
            .range([0, width])
            .padding(0.4);
        var y = d3.scaleLinear()
            .range([height, 0]);

        var tooltip = d3.select("body").append("div");

        // append the svg object to the divivsion
        var svg = d3.select("#column-chart-person").append("svg")
            .attr('preserveAspectRatio', 'xMinYMin meet')
            .attr(
                'viewBox',
                '0 0 ' +
                (width + margin.left + margin.right) +
                ' ' +
                (height + margin.top + margin.bottom)
            )
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        const bgGradient = svg
            .append('linearGradient')
            .attr('id', 'bg-gradient')
            .attr('gradientTransform', 'rotate(90)');
        bgGradient
            .append('stop')
            .attr('stop-color', '#fd1d1d')
            .attr('offset', '0%');
        bgGradient
            .append('stop')
            .attr('stop-color', '#9c0063')
            .attr('offset', '100%');

        let data = [];
        let temp = new Map();
        graph.nodes.forEach(d => {
            if (d.category === 1 && d.value !== '0') {
                d.value = d.value.substr(5);
                if (temp.get(d.value) === undefined) {
                    temp.set(d.value, 1);
                } else {
                    temp.set(d.value, temp.get(d.value)+1);
                }
            }
        })
        temp.forEach(function (value, key) {
            data.push({travellers: value, period: key});
        });
        console.log(data);

        // format the data
        data.forEach(function (d) {
            d.travellers = +d.travellers;
        });

        // Scale the range of the data in the domains
        x.domain(data.map(function (d) {
            return d.period;
        }));
        y.domain([0, d3.max(data, function (d) {
            return d.travellers;
        })]);

        var formatComma = d3.format(",");

        // append the rectangles for the bar chart
        svg.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("fill", "rgba(76, 142, 230, 1)")
            .attr("rx", 25)
            .attr("x", function (d) {
                return x(d.period);
            })
            .attr("width", x.bandwidth())
            .attr("y", function (d) {
                return y(d.travellers);
            })
            .attr("height", function (d) {
                return height - y(d.travellers);
            })
            //add tooltip
            .on("mousemove", function (d) {
                tooltip
                    .attr("class", "bar-tooltip")
                    .style("left", d3.event.pageX + 5 + "px")
                    .style("top", d3.event.pageY - 80 + "px")
                    .style("display", "inline-block")
                    .html((formatComma(d.travellers)));
            })
            .on("mouseout", function (d) {
                tooltip.style("display", "none");
            });

        // add the x Axis
        svg.append("g")
            .attr("class", "bar-chart-axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .call(g => g.select(".domain").remove());

    }


</script>
</body>
</html>
